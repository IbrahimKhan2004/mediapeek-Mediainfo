// User-provided "Full" MediaInfo JSON output
const sampleJson = {
  creatingLibrary: {
    name: 'MediaInfoLib',
    version: '25.07',
    url: 'https://mediaarea.net/MediaInfo',
  },
  media: {
    '@ref': '',
    track: [
      {
        '@type': 'General',
        Count: 359,
        StreamCount: 1,
        StreamKind: 'General',
        StreamKind_String: 'General',
        StreamKindID: 0,
        VideoCount: 1,
        AudioCount: 1,
        Video_Format_List: 'AVC',
        Video_Format_WithHint_List: 'AVC',
        Video_Codec_List: 'AVC',
        Audio_Format_List: 'AAC LC',
        Audio_Format_WithHint_List: 'AAC LC',
        Audio_Codec_List: 'AAC LC',
        Audio_Channels_Total: 2,
        Format: 'MPEG-4',
        Format_String: 'MPEG-4',
        Format_Extensions:
          'braw mov mp4 m4v m4a m4b m4p m4r 3ga 3gpa 3gpp 3gp 3gpp2 3g2 k3g jpm jpx mqv ismv isma ismt f4a f4b f4v',
        Format_Commercial: 'MPEG-4',
        Format_Profile: 'Base Media',
        InternetMediaType: 'video/mp4',
        CodecID: 'isom',
        CodecID_String: 'isom (isom/iso2/avc1/mp41)',
        CodecID_Url: 'http://www.apple.com/quicktime/download/standalone.html',
        CodecID_Compatible: 'isom/iso2/avc1/mp41',
        FileSize: '4372373',
        FileSize_String: '4.17 MiB',
        FileSize_String1: '4 MiB',
        FileSize_String2: '4.2 MiB',
        FileSize_String3: '4.17 MiB',
        FileSize_String4: '4.170 MiB',
        Duration: 52.209,
        Duration_String: '52 s 209 ms',
        Duration_String1: '52 s 209 ms',
        Duration_String2: '52 s 209 ms',
        Duration_String3: '00:00:52.209',
        Duration_String4: '00:00:52:05',
        Duration_String5: '00:00:52.209 (00:00:52:05)',
        OverallBitRate_Mode: 'VBR',
        OverallBitRate_Mode_String: 'Variable',
        OverallBitRate: 669980,
        OverallBitRate_String: '670 kb/s',
        FrameRate: 24,
        FrameRate_String: '24.000 FPS',
        FrameCount: 1253,
        StreamSize: 39504,
        StreamSize_String: '38.6 KiB (1%) / 38.6 KiB (1%)',
        StreamSize_String1: '39 KiB',
        StreamSize_String2: '39 KiB',
        StreamSize_String3: '38.6 KiB',
        StreamSize_String4: '38.58 KiB',
        StreamSize_String5: '38.6 KiB (1%) / 38.6 KiB (1%)',
        StreamSize_Proportion: '0.00903',
        HeaderSize: 40,
        DataSize: 4332877,
        FooterSize: 39456,
        IsStreamable: 'No',
        Title: 'Sintel Trailer',
        Movie: 'Sintel Trailer',
        Performer: 'Durian Open Movie Team',
        Description: 'Trailer for the Sintel open movie project',
        Encoded_Date: '1970-01-01 00:00:00 UTC',
        Tagged_Date: '1970-01-01 00:00:00 UTC',
        Encoded_Application: 'Lavf52.62.0',
        Encoded_Application_String: 'Lavf52.62.0',
        Copyright: '(c) copyright Blender Foundation | durian.blender.org',
        CompleteName: 'https://media.w3.org/2010/05/sintel/trailer.mp4',
      },
      {
        '@type': 'Video',
        Count: 391,
        StreamCount: 1,
        StreamKind: 'Video',
        StreamKind_String: 'Video',
        StreamKindID: 0,
        StreamOrder: '0',
        ID: '1',
        ID_String: '1',
        Format: 'AVC',
        Format_String: 'AVC',
        Format_Info: 'Advanced Video Codec',
        Format_Url: 'http://developers.videolan.org/x264.html',
        Format_Commercial: 'AVC',
        Format_Profile: 'High',
        Format_Level: '3',
        Format_Settings: 'CABAC / 5 Ref Frames',
        Format_Settings_CABAC: 'Yes',
        Format_Settings_CABAC_String: 'Yes',
        Format_Settings_RefFrames: 5,
        Format_Settings_RefFrames_String: '5 frames',
        InternetMediaType: 'video/H264',
        CodecID: 'avc1',
        CodecID_Info: 'Advanced Video Coding',
        Duration: 52.209,
        Duration_String: '52 s 209 ms',
        Duration_String1: '52 s 209 ms',
        Duration_String2: '52 s 209 ms',
        Duration_String3: '00:00:52.209',
        Duration_String4: '00:00:52:05',
        Duration_String5: '00:00:52.209 (00:00:52:05)',
        BitRate: 537876,
        BitRate_String: '538 kb/s',
        Width: 854,
        Width_String: '854 pixels',
        Height: 480,
        Height_String: '480 pixels',
        Stored_Width: 864,
        Sampled_Width: 854,
        Sampled_Height: 480,
        PixelAspectRatio: 1,
        DisplayAspectRatio: 1.779,
        DisplayAspectRatio_String: '16:9',
        Rotation: '0.000',
        FrameRate_Mode: 'CFR',
        FrameRate_Mode_String: 'Constant',
        FrameRate_Mode_Original: 'VFR',
        FrameRate: 24,
        FrameRate_String: '24.000 FPS',
        FrameRate_Num: 24,
        FrameRate_Den: 1,
        FrameCount: 1253,
        ColorSpace: 'YUV',
        ChromaSubsampling: '4:2:0',
        ChromaSubsampling_String: '4:2:0',
        BitDepth: 8,
        BitDepth_String: '8 bits',
        ScanType: 'Progressive',
        ScanType_String: 'Progressive',
        BitsPixel_Frame: 0.055,
        StreamSize: 3510198,
        StreamSize_String: '3.35 MiB (80%) / 3.35 MiB (80%)',
        StreamSize_String1: '3 MiB',
        StreamSize_String2: '3.3 MiB',
        StreamSize_String3: '3.35 MiB',
        StreamSize_String4: '3.348 MiB',
        StreamSize_String5: '3.35 MiB (80%) / 3.35 MiB (80%)',
        StreamSize_Proportion: '0.80281',
        Encoded_Date: '1970-01-01 00:00:00 UTC',
        Tagged_Date: '1970-01-01 00:00:00 UTC',
        extra: {
          CodecConfigurationBox: 'avcC',
        },
      },
      {
        '@type': 'Audio',
        Count: 285,
        StreamCount: 1,
        StreamKind: 'Audio',
        StreamKind_String: 'Audio',
        StreamKindID: 0,
        StreamOrder: '1',
        ID: '2',
        ID_String: '2',
        Format: 'AAC',
        Format_String: 'AAC LC',
        Format_Info: 'Advanced Audio Codec Low Complexity',
        Format_Commercial: 'AAC',
        Format_AdditionalFeatures: 'LC',
        CodecID: '2 / 40 / mp4a-40-2',
        Duration: 51.947,
        Duration_String: '51 s 947 ms',
        Duration_String1: '51 s 947 ms',
        Duration_String2: '51 s 947 ms',
        Duration_String3: '00:00:51.947',
        Duration_String5: '00:00:51.947',
        BitRate_Mode: 'VBR',
        BitRate_Mode_String: 'Variable',
        BitRate: 126694,
        BitRate_String: '127 kb/s',
        Channels: 2,
        Channels_String: '2 channels',
        ChannelPositions: 'Front: L R',
        ChannelPositions_String2: '2/0/0',
        ChannelLayout: 'L R',
        SamplesPerFrame: 1024,
        SamplingRate: 48000,
        SamplingRate_String: '48.0 kHz',
        SamplingCount: 2493456,
        FrameRate: 46.875,
        FrameRate_String: '46.875 FPS (1024 SPF)',
        FrameCount: 2435,
        Compression_Mode: 'Lossy',
        Compression_Mode_String: 'Lossy',
        StreamSize: 822671,
        StreamSize_String: '803 KiB (19%) / 803 KiB (19%)',
        StreamSize_String1: '803 KiB',
        StreamSize_String2: '803 KiB',
        StreamSize_String3: '803 KiB',
        StreamSize_String4: '803.4 KiB',
        StreamSize_String5: '803 KiB (19%) / 803 KiB (19%)',
        StreamSize_Proportion: '0.18815',
        Encoded_Date: '1970-01-01 00:00:00 UTC',
        Tagged_Date: '1970-01-01 00:00:00 UTC',
      },
    ],
  },
};

const keyMapping: Record<string, string> = {
  // General
  StreamCount: 'Count of stream of this kind',
  StreamKind: 'Kind of stream',
  StreamKindID: 'Stream identifier',
  VideoCount: 'Count of video streams',
  AudioCount: 'Count of audio streams',
  TextCount: 'Count of text streams',
  MenuCount: 'Count of menu streams',
  ImageCount: 'Count of image streams',
  Video_Codec_List: 'Codecs Video',
  Audio_Codec_List: 'Audio codecs',
  CompleteName: 'Complete name',
  FolderName: 'Folder name',
  FileName: 'File name',
  FileExtension: 'File extension',
  Format: 'Format',
  Format_Extensions: 'Format/Extensions usually used',
  Format_Commercial: 'Commercial name',
  Format_Profile: 'Format profile',
  InternetMediaType: 'Internet media type',
  CodecID: 'Codec ID',
  CodecID_Url: 'Codec ID/Url',
  CodecID_Compatible: 'CodecID_Compatible',
  FileSize: 'File size',
  Duration: 'Duration',
  OverallBitRate_Mode: 'Overall bit rate mode',
  OverallBitRate: 'Overall bit rate',
  FrameRate: 'Frame rate',
  FrameCount: 'Frame count',
  StreamSize: 'Stream size',
  StreamSize_Proportion: 'Proportion of this stream',
  HeaderSize: 'HeaderSize',
  DataSize: 'DataSize',
  FooterSize: 'FooterSize',
  IsStreamable: 'IsStreamable',
  Title: 'Title',
  Movie: 'Movie name',
  Performer: 'Performer',
  Description: 'Description',
  Encoded_Date: 'Encoded date',
  Tagged_Date: 'Tagged date',
  File_Modified_Date: 'File last modification date',
  File_Modified_Date_Local: 'File last modification date (local)',
  Encoded_Application: 'Writing application',
  Copyright: 'Copyright',

  // Video
  ID: 'ID',
  Format_Info: 'Format/Info',
  Format_Url: 'Format/Url',
  Format_Settings: 'Format settings',
  Format_Settings_CABAC: 'Format settings, CABAC',
  Format_Settings_RefFrames: 'Format settings, Reference frames',
  BitRate: 'Bit rate',
  Width: 'Width',
  Height: 'Height',
  Stored_Width: 'Stored_Width',
  Sampled_Width: 'Sampled_Width',
  Sampled_Height: 'Sampled_Height',
  PixelAspectRatio: 'Pixel aspect ratio',
  DisplayAspectRatio: 'Display aspect ratio',
  Rotation: 'Rotation',
  FrameRate_Mode: 'Frame rate mode',
  FrameRate_Mode_Original: 'FrameRate_Mode_Original',
  FrameRate_Num: 'FrameRate_Num',
  FrameRate_Den: 'FrameRate_Den',
  ColorSpace: 'Color space',
  ChromaSubsampling: 'Chroma subsampling',
  BitDepth: 'Bit depth',
  ScanType: 'Scan type',
  BitsPixel_Frame: 'Bits/(Pixel*Frame)',
  WritingLibrary: 'Writing library',
  Encoded_Library_Name: 'Encoded_Library_Name',
  Encoded_Library_Version: 'Encoded_Library_Version',
  Encoding_Settings: 'Encoding settings',
  CodecConfigurationBox: 'Codec configuration box',

  // Audio
  Channels: 'Channel(s)',
  ChannelPositions: 'Channel positions',
  ChannelLayout: 'Channel layout',
  SamplesPerFrame: 'Samples per frame',
  SamplingRate: 'Sampling rate',
  SamplingCount: 'Samples count',
  Compression_Mode: 'Compression mode',
  BitRate_Mode: 'Bit rate mode',

  // Fallbacks/Others
  Format_AdditionalFeatures: 'Format_AdditionalFeatures', // CLI often merges this into Format line or shows as distinct? User CLI has "Format_AdditionalFeatures : LC" in JSON? No, CLI output provided earlier showed "Format_AdditionalFeatures" line? Actually user output has `Format_AdditionalFeatures : LC` in the JSON, but CLI text output had `Format : AAC LC` and `Commercial name : AAC`. It seems CLI text doesn't explicitly show `Format_AdditionalFeatures` as a separate key often. But if JSON has it, we print it.
};

// Keys to essentially ignore or formatted differently in CLI
const ignoredKeys = new Set([
  '@type',
  '@typeorder',
  'extra',
  'Count', // CLI shows "Count" sometimes but usually redundant if StreamCount exists
  'StreamOrder',
  'FirstPacketOrder',
  'Inform',
  'StreamKind_String', // mapped via StreamKind usually
  'Simple_Profile', // Internal
]);

function getDisplayKey(jsonKey: string): string {
  // 1. Direct match
  if (keyMapping[jsonKey]) return keyMapping[jsonKey];

  // 2. Strip suffixes like _String, _String1... or _Url to find base key
  // e.g. "FileSize_String3" -> "FileSize"
  const baseKey = jsonKey.replace(/(_String\d*|_Url)$/, '');

  // 3. Check map for base key
  if (keyMapping[baseKey]) return keyMapping[baseKey];

  // 4. Fallback: formatted snake case OF THE BASE KEY
  // This ensures that "BitRate_Mode_String" falls back to "BitRate Mode"
  // (which looks like a repetition of "BitRate Mode") rather than "BitRate Mode String".
  return baseKey.replace(/_/g, ' ').trim();
}

interface MediaTrack {
  '@type': string;
  extra?: Record<string, unknown>;
  [key: string]: unknown;
}

function jsonToText(json: { media?: { track?: MediaTrack[] } }): string {
  if (!json || !json.media || !Array.isArray(json.media.track)) {
    return '';
  }

  const lines: string[] = [];
  const COLUMN_WIDTH = 40;

  json.media.track.forEach((track: MediaTrack) => {
    // Header
    const type = track['@type'];
    lines.push(type);

    const processKey = (key: string, value: unknown) => {
      if (ignoredKeys.has(key)) return;

      // Skip purely internal keys often not desired
      if (
        key === 'StreamKind' &&
        track['@type'] === 'General' &&
        value === 'General'
      )
        return; // redundant

      let displayValue = value;
      if (typeof value === 'object' && value !== null) {
        displayValue = JSON.stringify(value);
      }
      if (
        displayValue === '' ||
        displayValue === null ||
        displayValue === undefined
      )
        return;

      const displayKey = getDisplayKey(key);

      // Handling strict override for "Count" if needed, but "Count" is in map?
      // Actually "Count" maps to "Count" which is fine.

      let padding = COLUMN_WIDTH - displayKey.length;
      if (padding < 1) padding = 1;

      lines.push(`${displayKey}${' '.repeat(padding)}: ${displayValue}`);
    };

    // Standard keys
    Object.keys(track).forEach((key) => {
      if (key !== 'extra') processKey(key, track[key]);
    });

    // Extra keys
    // Extra keys
    const extra = track.extra;
    if (extra) {
      Object.keys(extra).forEach((extraKey) => {
        processKey(extraKey, extra[extraKey]);
      });
    }

    lines.push('');
  });

  return lines.join('\n');
}

console.log(jsonToText(sampleJson));
